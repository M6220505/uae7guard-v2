import { db } from "./db";
import { eq, desc, sql } from "drizzle-orm";
import { 
  users, userReputation, scamReports, 
  securityLogs, alerts, watchlist 
} from "@shared/schema";

export class DatabaseStorage {
  // --- Ù…Ù†Ø·Ù‚ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø±ØªØ¨ (Rank Logic) ---
  async updateReputation(userId: number, points: number) {
    const [current] = await db.select().from(userReputation).where(eq(userReputation.userId, userId));
    const newScore = (current?.trustScore || 0) + points;
    
    let newRank = "Novice";
    if (newScore > 500) newRank = "Sentinel";
    else if (newScore > 100) newRank = "Investigator";
    else if (newScore > 20) newRank = "Analyst";

    await db.insert(userReputation).values({ userId, trustScore: newScore, rank: newRank })
      .onConflictDoUpdate({
        target: userReputation.userId,
        set: { trustScore: newScore, rank: newRank, lastUpdated: new Date() }
      });
  }

  // --- Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª (Admin Logic & Dispatcher) ---
  async verifyScamReport(reportId: number) {
    const [report] = await db.update(scamReports).set({ status: "verified" })
      .where(eq(scamReports.id, reportId)).returning();

    if (report) {
      // 1. Ù…ÙƒØ§ÙØ£Ø© Ø§Ù„Ù…Ø­Ù‚Ù‚
      await this.updateReputation(report.reporterId, 50);

      // 2. ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨ÙŠÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Early Warning)
      const watchers = await db.select().from(watchlist).where(eq(watchlist.address, report.scammerAddress));
      for (const watcher of watchers) {
        await db.insert(alerts).values({
          userId: watcher.userId,
          title: "ğŸš¨ ØªÙ‡Ø¯ÙŠØ¯ Ù…Ø¤ÙƒØ¯: Ù‚Ø§Ø¦Ù…Ø© Ø³ÙˆØ¯Ø§Ø¡",
          message: `Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø°ÙŠ ØªØ±Ø§Ù‚Ø¨Ù‡ (${report.scammerAddress}) ØªÙ… ØªØµÙ†ÙŠÙÙ‡ ÙƒØ§Ø­ØªÙŠØ§Ù„ Ù…Ø¤ÙƒØ¯.`,
          severity: "high"
        });
      }
    }
  }

  // --- Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ (Emergency Audit Log) ---
  async logEmergencyAction(userId: number, address: string, details: string) {
    await db.insert(securityLogs).values({
      userId,
      actionType: "EMERGENCY_SECURE_ASSETS",
      targetAddress: address,
      details: details
    });
  }

  // --- Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø§Ø³ØªØ®Ø¨Ø§Ø±ÙŠ Ø§Ù„Ø³Ø±ÙŠØ¹ (Indexed Search) ---
  async searchThreat(address: string) {
    return await db.select().from(scamReports)
      .where(eq(scamReports.scammerAddress, address.toLowerCase()));
  }
}

export const storage = new DatabaseStorage();
